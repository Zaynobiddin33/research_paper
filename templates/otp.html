{% extends "base.html" %}
{% load static %}

{% block style %}
<!-- Bootstrap & Font -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

<style>
  :root {
    --accent: #2563eb;
    --bg: #f9fafb;
    --text: #111827;
    --muted: #6b7280;
    --card-shadow: 0 6px 20px rgba(17,24,39,0.06);
    --radius: 14px;
  }

  html, body {
    height: 100%;
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  body { padding-top: 72px; }

  nav.navbar {
    background: #fff;
    box-shadow: 0 1px 6px rgba(0,0,0,0.05);
  }

  .navbar-brand { color: var(--accent); font-weight: 700; letter-spacing: -0.3px; }

  .otp-hero {
    text-align: center;
    padding: 80px 16px 30px;
    background: linear-gradient(180deg,#ffffff 0%, #f3f4f6 100%);
  }

  .otp-card {
    max-width: 560px;
    margin: 0 auto;
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--card-shadow);
    padding: 28px;
  }

  .otp-title {
    font-size: clamp(1.3rem, 2.4vw, 1.6rem);
    font-weight: 700;
    margin-bottom: 6px;
  }

  .otp-desc {
    color: var(--muted);
    margin-bottom: 20px;
  }

  .otp-inputs {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 18px 0 10px;
  }

  .otp-inputs input {
    width: 48px;
    height: 56px;
    text-align: center;
    font-size: 1.35rem;
    border-radius: 10px;
    border: 1px solid #e6e9ef;
    outline: none;
    background: #fbfdff;
    transition: box-shadow .12s, border-color .12s;
  }

  .otp-inputs input:focus {
    border-color: var(--accent);
    box-shadow: 0 6px 18px rgba(37,99,235,0.08);
    background: white;
  }

  .otp-note { color: var(--muted); font-size: .95rem; margin-top: 10px; text-align: center; }

  .btn-verify {
    background: var(--accent);
    border: none;
    color: #fff;
    border-radius: 10px;
    padding: 10px 18px;
    font-weight: 600;
  }

  .btn-verify:disabled {
    opacity: .6;
    cursor: not-allowed;
  }

  .resend-row {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
    margin-top: 12px;
  }

  .timer {
    color: var(--muted);
    font-size: .95rem;
  }

  .error {
    color: #dc2626;
    font-size: .92rem;
    margin-top: 8px;
    text-align: center;
  }

  @media (max-width: 420px){
    .otp-inputs input { width: 42px; height: 52px; font-size: 1.2rem; }
    .otp-card { padding: 20px; }
  }
</style>
{% endblock %}

{% block content %}
<section class="otp-hero">
  <div class="container">
    <div class="otp-card">
      <div class="text-center">
        <div class="otp-title">Enter Verification Code</div>
        <div class="otp-desc">
          We sent a one-time 8-digit code to <strong id="userContact">your.email@example.com</strong>.
          Enter it below to verify your account.
        </div>
      </div>

      <!-- OTP Form -->
      <form id="otpForm" method="POST" action="" novalidate>
        {% csrf_token %}

        <div class="otp-inputs" role="group" aria-label="8 digit one time code">
          {% for i in "12345678" %}
            <input inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit {{ forloop.counter }}" class="otp-digit" />
          {% endfor %}
        </div>

        <!-- Hidden input for joined code -->
        <input type="hidden" name="otp" id="otpHidden" />

        <div class="d-flex justify-content-center mt-3">
          <button id="verifyBtn" type="submit" class="btn-verify" disabled>Verify</button>
        </div>

        <div class="resend-row">
          <button id="resendBtn" type="button" class="btn btn-link p-0" disabled>Resend code</button>
          <div class="timer" id="timerText">Resend available in <strong id="timer">00:30</strong></div>
        </div>

        <div id="errorMsg" class="error" role="alert" aria-live="assertive" style="display:none"></div>
      </form>

      <p class="otp-note">Didn't receive it? Check spam, or request a new code.</p>
    </div>
  </div>
</section>

<script>
(function() {
  const inputs = Array.from(document.querySelectorAll('.otp-digit'));
  const otpHidden = document.getElementById('otpHidden');
  const verifyBtn = document.getElementById('verifyBtn');
  const errorMsg = document.getElementById('errorMsg');
  const resendBtn = document.getElementById('resendBtn');
  const timerText = document.getElementById('timerText');
  const timerElem = document.getElementById('timer');

  inputs[0].focus();

  function updateHiddenAndState() {
    const code = inputs.map(i => i.value.trim()).join('');
    otpHidden.value = code;
    verifyBtn.disabled = code.length !== inputs.length || !/^\d{8}$/.test(code);
  }

  inputs.forEach((input, idx) => {
    input.addEventListener('input', (e) => {
      const val = e.target.value;
      if (!/^\d$/.test(val)) {
        e.target.value = val.replace(/\D/g, '').slice(0,1);
      }
      if (e.target.value && idx < inputs.length - 1) {
        inputs[idx + 1].focus();
        inputs[idx + 1].select();
      }
      updateHiddenAndState();
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && idx > 0) {
        inputs[idx - 1].focus();
        inputs[idx - 1].select();
      } else if (e.key === 'ArrowLeft' && idx > 0) {
        inputs[idx - 1].focus();
      } else if (e.key === 'ArrowRight' && idx < inputs.length - 1) {
        inputs[idx + 1].focus();
      }
    });

    input.addEventListener('paste', handlePaste);
  });

  function handlePaste(e) {
    e.preventDefault();
    const paste = (e.clipboardData || window.clipboardData).getData('text') || '';
    const digits = paste.replace(/\D/g, '').slice(0, inputs.length).split('');
    if (digits.length === 0) return;
    inputs.forEach((input, i) => { input.value = digits[i] || ''; });
    const nextIndex = digits.length >= inputs.length ? inputs.length - 1 : digits.length;
    inputs[nextIndex].focus();
    updateHiddenAndState();
  }

  document.getElementById('otpForm').addEventListener('submit', function(e) {
    // Normal Django form submit â€” server receives `otp`
    // No JS verification blocking unless invalid
    if (!/^\d{8}$/.test(otpHidden.value.trim())) {
      e.preventDefault();
      errorMsg.textContent = 'Please enter the 8-digit code.';
      errorMsg.style.display = 'block';
    }
  });

  let countdown = 30;
  let interval = setInterval(() => {
    countdown--;
    const mm = String(Math.floor(countdown / 60)).padStart(2, '0');
    const ss = String(countdown % 60).padStart(2, '0');
    timerElem.textContent = `${mm}:${ss}`;
    if (countdown <= 0) {
      clearInterval(interval);
      resendBtn.disabled = false;
      timerText.textContent = 'You can resend the code now.';
    }
  }, 1000);

  resendBtn.addEventListener('click', () => {
    resendBtn.disabled = true;
    countdown = 30;
    timerElem.textContent = '00:30';
    timerText.textContent = 'Resend available in';
    interval = setInterval(() => {
      countdown--;
      const mm = String(Math.floor(countdown / 60)).padStart(2,'0');
      const ss = String(countdown % 60).padStart(2,'0');
      timerElem.textContent = `${mm}:${ss}`;
      if (countdown <= 0) {
        clearInterval(interval);
        resendBtn.disabled = false;
        timerText.textContent = 'You can resend the code now.';
      }
    }, 1000);
  });

})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}